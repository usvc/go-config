image: golang:1.13
stages:
  - test
  - build
  - package
  - release
  - publish

test:
  stage: test
  cache:
    key: ${CI_PROJECT_REF}_${CI_COMMIT_REF_NAME}
    paths:
      - ./vendor
  artifacts:
    expire_in: 1 day
    paths:
      - ./vendor
      - ./c.out
  before_script:
    - apt-get update && apt-get upgrade -y
    - apt-get install -y make g++
  script:
    - make deps
    - make test

build:
  stage: build
  artifacts:
    expire_in: 1 day
    paths:
      - ./bin/*
  before_script:
    - apt-get update && apt-get upgrade -y
    - apt-get install -y make git g++
  script:
    - GOOS=linux GOARCH=amd64 make build_production \
      & GOOS=darwin GOARCH=amd64 make build_production \
      & GOOS=windows GOARCH=386 BIN_EXT=.exe make build_production

compress:
  stage: package
  # allow failure because it's not necessary to always compress
  # even though that would be nice
  allow_failure: true
  dependencies:
    - build
  artifacts:
    expire_in: 1 day
    paths:
      - ./bin/*
  before_script:
    - apt-get update && apt-get upgrade -y
    - apt-get install -y make g++ upx
  script:
    - GOOS=linux GOARCH=amd64 make compress_production \
      & GOOS=darwin GOARCH=amd64 make compress_production \
      & GOOS=windows GOARCH=386 BIN_EXT=.exe make compress_production

version bump:
  stage: release
  only:
    - master
  image: usvc/semver:gitlab-latest
  before_script:
    - apk update && apk upgrade
    - apk add openssh
    - mkdir -p ~/.ssh
    - 'printf -- "${DEPLOY_KEY}" | base64 -d > ~/.ssh/id_rsa'
    - chmod 600 -R ~/.ssh/id_rsa
    - ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts
  script:
    - git remote set-url origin "git@gitlab.com:${CI_PROJECT_PATH}.git"
    - git checkout master
    - git fetch
    - semver bump --git --apply
    - git push origin master --verbose --tags
  after_script:
    - rm -rf ~/.ssh/*
